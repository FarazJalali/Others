name: Auto Update Google Sites Mirror

on:
  schedule:
    - cron: '0 0 * * *'   # هر روز ساعت ۰۰:۰۰ UTC ≈ ۳:۳۰ صبح ایران
  workflow_dispatch:      # برای اجرای دستی

jobs:
  mirror-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # اجازه commit و push
      pages: write        # اجازه deploy به GitHub Pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install wget
        run: sudo apt-get update && sudo apt-get install wget -y

      - name: Mirror the Google Sites
        run: |
          rm -rf temp public || true
          mkdir -p temp
          cd temp
          
          # دانلود سایت
          wget --mirror \
               --convert-links \
               --adjust-extension \
               --page-requisites \
               --no-parent \
               --no-host-directories \
               --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36" \
               https://sites.google.com/view/adm-parsianlift/home
          
          # دیباگ: نمایش ساختار فایل‌ها بعد از دانلود
          echo "Directory structure after wget:"
          ls -R .
          
          # تلاش برای استخراج محتوا از فولدرهای تو در تو
          shopt -s dotglob nullglob
          
          # اگر فولدر home در هر عمقی پیدا شد
          if compgen -G "**/home" > /dev/null; then
            echo "Found nested 'home' folder(s), extracting content..."
            find . -type d -name "home" -exec sh -c 'cp -r "$0/." .' {} \; || true
            find . -type d -name "home" -exec rm -rf {} \; || true
          fi
          
          # حذف فولدرهای اضافی باقی‌مانده
          rm -rf view adm-parsianlift sites.google.com 2>/dev/null || true
          
          # اگر home.html وجود داشت → تبدیل به index.html
          if [ -f "home.html" ]; then
            echo "Renaming home.html → index.html"
            mv home.html index.html
          fi
          
          # اگر هنوز index.html نبود → یک فایل ساده برای دیباگ بساز
          if [ ! -f "index.html" ]; then
            echo "Warning: No index.html found after extraction"
            echo "<h1>Site mirrored but no index.html detected - check logs</h1>" > index.html
          fi
          
          # دیباگ نهایی: فایل‌های ریشه
          echo "Final files in root after extraction:"
          ls -la .
          
          cd ..
          rm -rf public || true
          mv temp public

      - name: Commit changes if any
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add .
          git diff --quiet && git diff --staged --quiet || git commit -m "Auto update: Mirror from Google Sites"
          git push || echo "No changes to push"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true
