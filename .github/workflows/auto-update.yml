name: Auto Update Google Sites Mirror

on:
  schedule:
    - cron: '0 0 * * *'   # هر روز ساعت ۰۰:۰۰ UTC ≈ ۳:۳۰ صبح ایران
  workflow_dispatch:      # اجازه اجرای دستی

jobs:
  mirror-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # برای commit و push
      pages: write        # برای deploy به Pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install wget
        run: sudo apt-get update && sudo apt-get install wget -y

            - name: Mirror the Google Sites
        run: |
          rm -rf temp public || true
          mkdir -p temp
          cd temp
          
          # دانلود
          wget --mirror \
               --convert-links \
               --adjust-extension \
               --page-requisites \
               --no-parent \
               --no-host-directories \
               --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36" \
               https://sites.google.com/view/adm-parsianlift/home
          
          # دیباگ: ساختار بعد دانلود
          echo "Directory structure after wget:"
          ls -R .
          
          # استخراج از عمق فولدر (چند سطح ممکن)
          shopt -s dotglob  # برای hidden files
          if compgen -G "**/home" > /dev/null; then
            echo "Found nested home folder, extracting..."
            find . -type d -name "home" -exec cp -r {}/.. . \; || true
            find . -type d -name "home" -exec rm -rf {} \; || true
          fi
          
          # حذف فولدرهای باقی‌مانده view و adm-parsianlift
          rm -rf view adm-parsianlift 2>/dev/null || true
          
          # rename اگر home.html بود
          if [ -f "home.html" ]; then
            mv home.html index.html
          fi
          
          # fallback اگر index نبود
          if [ ! -f "index.html" ]; then
            echo "<h1>No index.html - mirror check needed</h1>" > index.html
          fi
          
          # دیباگ نهایی
          echo "Final root files:"
          ls -la .
          
          cd ..
          rm -rf public || true
          mv temp public
